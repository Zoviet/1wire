# Считывание кодов со считывателя Арсенал Портал-К и аналогов по DS1990 (1-Wire iButton) (ESP8266)

Документация на считыватель: https://arsenal-sib.ru/materials/documentation/portal_k_re.pdf?1

Описание протокола: https://en.wikipedia.org/wiki/1-Wire

Esptool: https://github.com/espressif/esptool

ESPlorer: https://esp8266.ru/esplorer/#download

Другие аналогичные считывали с кодонаборными панелями, работающие по протоколу iButton (DS1990а), работают в режиме кодонаборной панели аналогично:

1. До окончания ввода на кодонаборной панели считыватель на шине не присутствует, находясь в дежурном режиме;

2. После окончания ввода считыватель выставляет на шину свой адрес, в котором и содержится введенный на кодонаборной панели код и возвращается в дежурный режим. 

## Необходимые модули:

1. Ow (https://nodemcu.readthedocs.io/en/release/modules/ow/)
2. bit (https://nodemcu.readthedocs.io/en/release/modules/bit/)

Заливка прошивки NodeMcu с необходимыми модулями с помощью esptool:

```sh
python3 -m esptool --port /dev/ttyUSB0 erase_flash
python3 -m esptool --port /dev/ttyUSB0 write_flash -fm dio 0x00000 nodemcu-release-9-modules-2024-08-27-19-34-28-integer.bin
```

Самый простой способ залить сам пример - использование ESPlorer.

## Использование

***attempts*** - количество циклов чтения конкретного считывателя за 500 мс (для Портал-М 437), см. ниже

***timing*** - задержка после передачи считывателем кода. В некоторых считывателях может настраиваться и собственная блокировка клавиатуры после неуспешного и/или успешного ввода кода - в этом случае правильным будет выставить задержку опроса в то же значение, что и время блокировки клавиатуры на считывателе. 

Функция возвращает введенный на клавиатуре считывателя код в виде строки из десятичных цифр. 

----------------

Для получения данных необходимо постоянно опрашивать шину 1-wire, что из-за отсчета тайм-слота прижатия шины к земле приводит к необходимости сбрасывать системный таймер, что резко ограничивает возможности использования ESP в процессе опроса считывателя, поэтому опрос шины желательно сделать по требованию и выделить тайм-слоты для других операций. 

Тут необходимо отметить, что цикл инициализации производится при опросе шины постоянно - т.е. контроллер выдает на шину сигнал RESET (минимум 480 микросекунд), а устройство при наличии возвращает сигнал PRESENCE (от 60 до 240 микросекунд, по факту Портал-К роняет шину на землю почти на максимально допустимое по стандарту время - 200-230 микросекунд с учетом фронтов нарастания и спада при рекомендованной стандартом подтяжке на землю резистором 4.7 кОм). 

Минимальное время всего цикла инициализации таким образом составляет 960 микросекунд, а по факту составляет 1.1-1.5 миллисекунды вне зависимости от получения сигнала PRESENCE или нет. 

Это даёт возможность запускать процесс опроса шины по таймеру без риска потери данных, ограничив количество выдаваемых сигналов RESET на шину за цикл таймера (переменная attempts) исходя из тайминга времени инициализации считывателя на шине, таким образом, чтобы сброс таймера приходился на последний тайм-слот. Для Портал-К это 437 циклов за 0.5 секунды. 

В случае, если сигнал PRESENCE получен, таймер также останавливается, что дает возможность выполнить необходмую обработку полученных данных.
